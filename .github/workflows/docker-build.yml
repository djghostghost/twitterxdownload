name: Build and Deploy Next.js to Remote

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  issues: write

jobs:
  approval:
    runs-on: ubuntu-latest
    steps:
      - name: Manual Approval Before Production Deploy
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: djghostghost              # ğŸ‘ˆ ä½ çš„ GitHub è´¦å·
          minimum-approvals: 1
          exclude-workflow-initiator-as-approver: false
          issue-title: "Production Deployment Approval Required"
          issue-body: "Please approve this production deployment by replying 'approve' or deny by replying 'deny'."
          timeout-minutes: 60
  build-and-deploy:
    runs-on: ubuntu-latest
    needs: approval
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build Next.js project
        run: npm run build

      - name: ğŸ§¹ Clean up unnecessary files
        run: |
          rm -rf node_modules
          rm -rf .git

      - name: ğŸ“¦ Create tarball for deployment
        run: tar czf xvideo.tar.gz .next public package.json .env



      - name: ğŸš€ Deploy to Remote Server via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.REMOTE_KEY }}
          port: 22
          source: "xvideo.tar.gz"
          target: "/tmp"

      - name: ğŸ–¥ï¸ Remote SSH Commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.REMOTE_KEY }}
          port: 22
          script: |
            mkdir -p /var/www/xvideo
            tar xzf /tmp/xvideo.tar.gz -C /var/www/xvideo
            pm2 reload xvideo || pm2 start /var/www/xvideo/server.js --name xvideo
